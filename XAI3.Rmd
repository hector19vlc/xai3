---
title: "XAI 3: Model-Agnostic methods"
output: html_notebook
---

## EXERCISE:

Apply PDP to the regression example of predicting bike rentals. Fit a random forest approximation for the prediction of bike rentals (**cnt**). Use the partial dependence plot to visualize the relationships the model learned. Use the slides shown in class as model.  

## QUESTION:

Analyse the influence of **days since 2011, temperature, humidity** and **wind speed** on the predicted bike counts.


```{r}
library(dplyr)
library(plotly)
library(reshape2)
library(lubridate)
library(randomForestSRC)
setwd('.')
#setwd("/Users/cmonserr/OneDrive - UPV/Trabajo_2/Asignaturas/Evaluacion de modelos/Practicas/Practica 3/Bike-Sharing-Dataset")
days <- read.csv("day.csv")
hour <- read.csv("hour.csv")

days$dteday <- as_date(days$dteday)
days_since <- select(days, workingday, holiday, temp, hum, windspeed, cnt)
days_since$days_since_2011 <- int_length(interval(ymd("2011-01-01"), days$dteday)) / (3600*24)
days_since$SUMMER <- ifelse(days$season == 3, 1, 0)
days_since$FALL <- ifelse(days$season == 4, 1, 0)
days_since$WINTER <- ifelse(days$season == 1, 1, 0)
days_since$MISTY <- ifelse(days$weathersit == 2, 1, 0)
days_since$RAIN <- ifelse(days$weathersit == 3 | days$weathersit == 4, 1, 0)
days_since$temp <- days_since$temp * 47 - 8
days_since$hum <- days_since$hum * 100
days_since$windspeed <- days_since$windspeed * 67

rf <- rfsrc(cnt~., data=days_since)

results <- select(days_since, days_since_2011, temp, hum, windspeed, cnt)
nr <- nrow(days_since)
for(c in names(results)[1:4])
{
  for(i in 1:nr){
    r <- days_since
    r[[c]] <- days_since[[c]][i]
    sal <- predict(rf, r)$predicted
    results[[c]][i] <- sum(sal) / nr
  }
}


```
Gráficos 1D:

```{r}

p1 = ggplot(days_since, aes(x=temp,y=results$temp)) + geom_line() + geom_rug(alpha=0.1, sides="b") +ylim(0,6000) + labs(x='Temperature',y='')
p2 = ggplot(days_since, aes(x=hum,y=results$hum)) +geom_line() + geom_rug(alpha=0.1, sides="b")+ylim(0,6000)+labs(x='Humidity',y='')
p3 = ggplot(days_since, aes(x=days_since_2011,y=results$days_since_2011))+geom_line() + geom_rug(alpha=0.1, sides="b")+ylim(0,6000)+ labs(x='Days since 2011',y='prediction')
p4 = ggplot(days_since, aes(x=windspeed,y=results$windspeed))+geom_line() + geom_rug(alpha=0.1, sides="b")+ylim(0,6000)+ labs(x='Wind speed',y='')
subplot(p3,p1,p2,p4,titleX = TRUE,titleY = TRUE)
```
Days_since_2011 -> A medida que pasan días desde 2011, el número de bicis que se alquilan va aumentando progresivamente. Hasta a partir del día 625 aproximadamente desde 2011 que esta tendencia cambia y empieza a disminuir el alquiler de bicis. Es decir, que a finales de 2012 el alquiler de bicis empieza a disminuir respecto a la tendencia ascendente que se observaba hasta ese momento.

Temperature -> Al igual que con la variable anterior, el alquiler de bicis aumenta conforme lo hace la temperatura, hasta que llegamos a temperaturas de alrededor de 28-30 grados donde el alquiler de bicis disminuye ligeramente. En otras palabras, cuando hace mucho frío o hace mucho calor el alquiler de bicis es menor que cuando  nos encontramos en épocas de entretiempo.

Humidity -> La humedad es una variable que no afecta al número de alquileres de bicicletas durante la mayor parte de su rango de valores. Únicamente el alquiler de bicis empieza a disminuir para valores de humedad superiores al 50%. Para valores inferiores, el número de alquileres permanece constante.

Wind Speed -> Al igual que con humidity, la velocidad del viento tiene una correlación negativa con el número de alquileres, ya que a medida que las ráfagas de viento son superiores el número de alquileres disminuye, a lo largo de todo el rango de valores de la variable 'Wind Speed'.


## EXERCISE:

Generate a 2D Partial Dependency Plot with humidity and temperature to predict the number of bikes rented depending of those parameters.

BE CAREFUL: due to the size, extract a set of random samples from the BBDD before generating the the data for the Partial Dependency Plot. 

Show the density distribution of both input features with the 2D plot as shown in the class slides. 

TIP: Use geom_tile() to generate the 2D plot. Set width and height to avoid holes. 

## QUESTION:

Interpret the results.


```{r}

sampled <- sample_n(days_since, 40)
temp <- sampled$temp
hum <- sampled$hum
th <- inner_join(data.frame(temp),data.frame(hum), by=character())
th$p <- 0

for(i in 1:nrow(th)){
  r <- days_since
  r[["temp"]] <- th[["temp"]][i]
  r[["hum"]] <- th[["hum"]][i]
  
  sal <- predict(rf, r)$predicted
  th[["p"]][i] <- sum(sal) / nr
}

```

Creamos el 2D plot:

```{r}

ggplot(th, aes(x=temp,y=hum,fill=p,width=12,height=12)) + geom_tile() + labs(x='Temperature', y= 'Humidity',fill = 'Number of bikes')
```

En el gráfico con 2 dimensiones podemos corroborar lo que hemos observado en los gráficos anteriores de una variable. El número de alquileres de bicicletas es muy bajo para niveles de humedad altos y temperaturas bajas, ya que es en esta región del mapa donde se obtienen unos peores valores. Por el contrario, para niveles de humrfad entre 0 y 80% y temperaturas entre 15 y 30 grados es cuando se alcanza un mayor número de alquileres de bicicletas. Con las mismas condiciones de humedad y más de 30 grados de temperatura, los alquileres tambíen tienen un valor alto, pero ligeramente inferior a las condiciones óptimas que hemos comentado anteriormente.

Por otra parte, si la temperatura es inferior a los 15 grados y la humedad se mantiene en valores óptimos (0-80%), el número de alquileres es ligeramente inferior que si la temperatura se mantiene en niveles óptimos (15-30º) y la humedad es muy alta (80-100%), esto se puede interpretar con que la gente, a la hora de alquilar una bicicleta, prefiere antes una temperatura adecuada que unos niveles de humedad óptimos, aunque con una muestra de solo 40 observaciones es difícil obtener conclusiones claras.

En conclusión, este gráfico en 2 dimensiones confirma las interpetaciones que hemos hecho de los gráficos univariantes y parece que indica que las personas que alquilan bicis priorizan una buena temperatura que unas buenas condiciones de humedad.


## EXERCISE:

Apply the previous concepts to predict the **price** of a house from the database **kc_house_data.csv**. In this case, use again a random forest approximation for the prediction based on the features **bedrooms**, **bathrooms**, **sqft_living**, **sqft_lot**, **floors** and **yr_built**. 
Use the partial dependence plot to visualize the relationships the model learned.

BE CAREFUL: due to the size, extract a set of random samples from the BBDD before generating the data for the Partial Dependency Plot. 

## QUESTION:

Analyse the influence of **bedrooms, bathrooms, sqft_living** and **floors** on the predicted price.


```{r}

d <- read.csv("kc_house_data.csv")

sampled <- sample_n(d, 1000)

sampled <- select(sampled, bedrooms, bathrooms, sqft_living, sqft_lot, floors, yr_built, price)

rf <- rfsrc(price~., data=sampled)

results <- select(sampled, bedrooms, bathrooms, sqft_living, floors, price)
nr <- nrow(sampled)
for(c in names(results)[1:4])
{
  for(i in 1:nr){
    r <- sampled
    r[[c]] <- sampled[[c]][i]
    sal <- predict(rf, r)$predicted
    results[[c]][i] <- sum(sal) / nr
  }
}

```

Realizando los gráficos 1D:

```{r}
p1 = ggplot(sampled, aes(x=bedrooms,y=results$bedrooms)) + geom_line() + geom_rug(alpha=0.1, sides="b") + labs(x='Bedrooms',y='')
p2 = ggplot(sampled, aes(x=bathrooms,y=results$bathrooms)) +geom_line()+ geom_rug(alpha=0.1, sides="b")+labs(x='Bathrooms',y='')
p3 = ggplot(sampled, aes(x=sqft_living,y=results$sqft_living))+geom_line()+ geom_rug(alpha=0.1, sides="b")+ labs(x='Sqft Livings',y='')
p4 = ggplot(sampled, aes(x=floors,y=results$floors))+geom_line() + geom_rug(alpha=0.1, sides="b")+ labs(x='Floors',y='')
subplot(p1,p2,p3,p4,titleX = TRUE,titleY = TRUE)
```
Los gráficos salen ligeramente diferentes a los del modelo, debido a la selección de la muestra.


Bedrooms -> Las casas más caras de la muestras son las que tienen 2 dormitorios con bastante diferencia sobre el resto. Por lo demás, las viviendas de 1, 5, 6 y 10 dormitorios tienen un precio parecido. Por último, las viviendas de 3 y 4 habitaciones tienen el precio más bajo, bastante inferior que el resto de niveles de esta variable. Como la muestra es de 1000 viviendas y no sabemos cuantas hay de cada tipo, es posible que la información del gráfico esté sesgada y se trate de valores anómalos dentro de todo el conjunto de datos.

Bathrooms -> A medida de que vivienda dispone de más cuartos de baño, el precio de la vivienda aumenta. Hasta 4 baños, el precio de la casa va aumentando poco a poco, sin embargo, al pasar de 4 a 5 baños el salto que se da en el precio de la vivienda es muy grande. Esto puede deberse a que en la muestra solo hay una vivienda con 6 baños, la cual es muy cara.

Sqft Livings -> Esta variable sigue la misma tendencia que la anterior (Bathrooms), aunque ahora hablamos de una variable continua. Cuanta más superficie habitable tiene la casa, más cara es esta. Este aumento es más o menos constante, salvo por un pequeño tramo en el cual el precio permanece constante en viviendas de entre 4000 y 5000 unidades de superficie habitable.

Floors -> Por último, en esta variable discreta que indica los pisos que tiene la casa, volvemos a observar la misma tendencia que en las 2 variables anteriores. Cuantas más plantas tiene la vivienda, mayor es su precio.
